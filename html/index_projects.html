<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projetos - Claude Sessions</title>
    <link rel="stylesheet" href="../css/style.css">
    <script>
        document.documentElement.dataset.theme = 'light';
    </script>
</head>
<body>
    <div class="container">
        <!-- Navigation Link -->
        <a class="nav-link-top" href="index.html" title="Ir para o chat">‚ü≤ Chat</a>

        <div class="chat-container">
            <div id="sessions-list" class="messages sessions-list"></div>
        </div>
    </div>

    <script>
        // Remove any debug elements that might exist
        (function() {
            // Remove debug panel if it exists
            const debugPanel = document.getElementById('debug-visual-panel');
            if (debugPanel) debugPanel.remove();
            
            // Remove debug toggle button if it exists
            const debugToggle = document.getElementById('debug-toggle-btn');
            if (debugToggle) debugToggle.remove();
            
            // Remove debug styles if they exist
            const debugStyles = document.querySelectorAll('style');
            debugStyles.forEach(style => {
                if (style.textContent && style.textContent.includes('debug-visual-panel')) {
                    style.remove();
                }
            });
        })();
        
        window.addEventListener('load', async () => {
            const container = document.getElementById('sessions-list');

            try {
                const response = await fetch('http://localhost:8001/sessions');
                const data = await response.json();

                console.log('‚úÖ', data.count + ' sess√µes encontradas');

                if (data.sessions.length === 0) {
                    container.innerHTML = '<p class="empty-state">Nenhuma sess√£o encontrada</p>';
                    return;
                }

                // Detectar √∫ltima sess√£o acessada via localStorage ou documento.referrer
                const lastSessionId = localStorage.getItem('last_session_id');

                data.sessions.forEach((session, index) => {
                    const card = document.createElement('div');
                    card.className = 'session-card';

                    // Marcar sess√£o mais recente como ativa
                    const isActive = index === 0;
                    if (isActive) {
                        card.classList.add('active-session');
                    }

                    const filePath = (session.file || '').replace(/\\/g, '/');
                    const projectFolder = filePath.split('/').slice(-2, -1)[0] || 'Projeto desconhecido';
                    const updated = new Date(session.updated_at).toLocaleString('pt-BR');

                    const activeBadge = isActive ? '<span class="active-badge">‚ú® Atual</span>' : '';

                    card.innerHTML = `
                        <div class="session-card-header">
                            <div>
                                <h3>üóÇÔ∏è ${projectFolder}</h3>
                                <p class="session-card-subtitle">${session.file_name}</p>
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                ${activeBadge}
                                <span class="session-card-badge">${session.message_count} mensagens</span>
                                <button class="delete-session-btn" data-session-id="${session.session_id}" title="Deletar sess√£o">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="session-card-meta">
                            <div>ü§ñ ${session.model}</div>
                            <div class="session-card-date">üìÖ ${updated}</div>
                        </div>
                    `;

                    card.onclick = (e) => {
                        if (e.target.classList.contains('delete-session-btn')) {
                            return;
                        }
                        window.location.href = 'session-viewer.html?session_id=' + session.session_id;
                    };

                    const deleteBtn = card.querySelector('.delete-session-btn');
                    deleteBtn.onclick = async (e) => {
                        e.stopPropagation();

                        try {
                            const response = await fetch(`http://localhost:8001/sessions/${session.session_id}`, {
                                method: 'DELETE'
                            });

                            const result = await response.json();

                            if (result.success) {
                                console.log('‚úÖ', 'Sess√£o deletada: ' + session.file_name);
                                card.remove();
                            } else {
                                console.error('‚ùå', 'Erro ao deletar: ' + (result.error || 'Falha desconhecida'));
                            }
                        } catch (error) {
                            console.error('‚ùå', 'Erro ao deletar sess√£o: ' + error.message);
                        }
                    };

                    container.appendChild(card);
                });

            } catch (error) {
                console.error('Erro:', error);
                console.error('‚ùå', 'Falha ao carregar: ' + error.message);
                container.innerHTML = '<p class="empty-state error">‚ùå Erro ao carregar sess√µes</p>';
            }
        });
    </script>
</body>
</html>
